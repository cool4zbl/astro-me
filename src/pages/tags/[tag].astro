---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import BlogCard from '../../components/BlogCard.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const publishedPosts = allPosts.filter(post => !post.data.draft);
  
  // 获取所有唯一标签
  const uniqueTags = [...new Set(publishedPosts.flatMap(post => post.data.tags))];
  
  return uniqueTags.map(tag => ({
    params: { tag },
    props: {
      posts: publishedPosts
        .filter(post => post.data.tags.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    }
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout 
  title={`标签: ${tag} - 我的博客`}
  description={`浏览所有标记为 "${tag}" 的文章，共 ${posts.length} 篇。`}
>
  <Header />
  
  <main class="flex-1">
    <div class="container mx-auto px-4 py-16">
      <div class="mx-auto max-w-2xl lg:max-w-4xl">
        <header class="text-center mb-16">
          <div class="inline-flex items-center rounded-full bg-secondary px-4 py-2 text-sm font-medium text-secondary-foreground mb-4">
            标签
          </div>
          <h1 class="text-3xl font-bold tracking-tight text-foreground sm:text-4xl">
            {tag}
          </h1>
          <p class="mt-2 text-lg leading-8 text-muted-foreground">
            共 {posts.length} 篇文章
          </p>
          <div class="mt-6">
            <a
              href="/tags"
              class="text-sm font-medium text-primary hover:underline"
            >
              ← 返回所有标签
            </a>
          </div>
        </header>
        
        {posts.length > 0 ? (
          <div class="space-y-20 lg:space-y-20">
            {posts.map((post) => (
              <BlogCard post={post} />
            ))}
          </div>
        ) : (
          <div class="text-center py-16">
            <p class="text-muted-foreground">该标签下暂无文章</p>
          </div>
        )}
      </div>
    </div>
  </main>
  
  <Footer />
</BaseLayout>
