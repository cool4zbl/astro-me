---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getTagPageMetadata } from '../../utils/metadata';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const publishedPosts = allPosts.filter(post => !post.data.draft);

  // Get all unique tags
  const uniqueTags = [...new Set(publishedPosts.flatMap(post => post.data.tags))];

  return uniqueTags.map(tag => ({
    params: { tag },
    props: {
      posts: publishedPosts
        .filter(post => post.data.tags.includes(tag))
        .sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf())
    }
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
const { title: pageTitle, description: baseDescription } = getTagPageMetadata(tag);
const postCountText = posts.length === 1 ? '1 post available.' : `${posts.length} posts available.`;
const pageDescription = `${baseDescription} ${postCountText}`;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <Header />

  <main class="flex-1">
    <div class="container-width py-16">
      <div class="mx-auto max-w-2xl lg:max-w-4xl">
        <header class="text-center mb-16">
          <div class="inline-flex items-center rounded-full bg-secondary px-4 py-2 text-sm font-medium text-secondary-foreground mb-4">
            Tag
          </div>
          <h1 class="text-3xl font-bold tracking-tight text-foreground sm:text-4xl">
            {tag}
          </h1>
          <p class="mt-2 text-lg leading-8 text-muted-foreground">
            {posts.length} articles
          </p>
          <div class="mt-6">
            <a
              href="/tags"
              class="text-sm font-medium text-primary hover:underline"
            >
              ‚Üê Back to all tags
            </a>
          </div>
        </header>

        {posts.length > 0 ? (
          <div class="space-y-20 lg:space-y-20">
            {posts.map((post) => (
              <BlogCard post={post} />
            ))}
          </div>
        ) : (
          <div class="text-center py-16">
            <p class="text-muted-foreground">No articles found for this tag</p>
          </div>
        )}
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>
