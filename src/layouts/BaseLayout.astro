---
import Analytics from "@vercel/analytics/astro";
import SpeedInsights from "@vercel/speed-insights/astro";
import SEO from "../components/SEO.astro";
import GA from "../components/GA.astro";
import Baidu from "../components/Baidu.astro";
import { getLangFromUrl } from "../i18n/config";
import "../styles/globals.css";

export interface Props {
  title: string;
  description: string;
  image?: string;
  article?: boolean;
  publishedTime?: Date;
  modifiedTime?: Date;
  tags?: string[];
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const {
  title,
  description,
  image = "/og-image.jpg",
  article = false,
  publishedTime,
  modifiedTime,
  tags = [],
} = Astro.props;

const htmlLang = getLangFromUrl(Astro.url);
---

<!doctype html>
<html lang={htmlLang} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>ðŸ”¥</text></svg>"></link>
    <meta name="generator" content={Astro.generator} />

    <!-- SEO Component -->
    <SEO
      title={title}
      description={description}
      image={image}
      article={article}
      publishedTime={publishedTime}
      modifiedTime={modifiedTime}
      tags={tags}
    />
    <!-- RSS -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title={title}
      href={`${Astro.site}rss.xml`}
    />

    <!-- Sitemap -->
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://www.google-analytics.com">
    <link rel="preconnect" href="https://www.googletagmanager.com">

    <!-- æ·»åŠ è¯­è¨€åˆ‡æ¢æ”¯æŒçš„ hreflang -->
    <link rel="alternate" hreflang="en" href={`${Astro.site}`} />
    <link rel="alternate" hreflang="zh-CN" href={`${Astro.site}zh-CN/`} />
    <link rel="alternate" hreflang="x-default" href={`${Astro.site}`} />
    <!-- Google Fonts -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" />
    </noscript>
    <!-- Google Analytics Component -->
    <GA />
    <Baidu />
    <!-- Analytics Script -->
    <Analytics />
    <SpeedInsights />

    <!-- Theme Script -->
    <script is:inline>
      const getThemePreference = () => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        return window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      };
      const isDark = getThemePreference() === "dark";
      document.documentElement.classList[isDark ? "add" : "remove"]("dark");

      if (typeof localStorage !== "undefined") {
        const observer = new MutationObserver(() => {
          const isDark = document.documentElement.classList.contains("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");
        });
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ["class"],
        });
      }
    </script>
  </head>
  <body class="min-h-screen bg-background font-sans antialiased">
    <div class="relative flex min-h-screen flex-col">
      <slot />
    </div>
  </body>
</html>
