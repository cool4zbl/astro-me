---
import { siteConfig } from '@/config';

const { enabled, measurementId } = siteConfig.services.googleAnalytics;
---

{ enabled && <script async src={`https://www.googletagmanager.com/gtag/js?id=${measurementId}`
}></script> }

{ enabled && (
  <script is:inline define:vars={{ measurementId }}>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', measurementId);

    const sendPageView = () => {
      const { pathname, search, href } = window.location;
      const pagePath = pathname + search;

      if (window.__lastGtagPagePath === pagePath) {
        return;
      }

      window.__lastGtagPagePath = pagePath;
      gtag('config', measurementId, { 'page_path': pagePath });
      gtag('event', 'page_view', {
        page_path: pagePath,
        page_location: href,
        page_title: document.title,
      });
    };

    if (document.readyState === 'complete') {
      sendPageView();
    } else {
      window.addEventListener('load', sendPageView, { once: true });
    }

    window.addEventListener('astro:page-load', sendPageView);
    window.addEventListener('astro:after-swap', sendPageView);
  </script>
) }
